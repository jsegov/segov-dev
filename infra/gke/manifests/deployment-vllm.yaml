apiVersion: apps/v1
kind: Deployment
metadata:
  name: vllm
  namespace: inference
spec:
  replicas: ${VLLM_REPLICAS}
  selector:
    matchLabels:
      app: vllm
  template:
    metadata:
      labels:
        app: vllm
    spec:
      serviceAccountName: vllm-sa
      nodeSelector:
        cloud.google.com/gke-accelerator: '${GKE_GPU_TYPE}'
      containers:
        - name: vllm
          image: '${VLLM_IMAGE}'
          imagePullPolicy: IfNotPresent
          command:
            - python
            - -m
            - vllm.entrypoints.openai.api_server
          args:
            - --model
            - '${VLLM_MODEL_ID}'
            - --host
            - '0.0.0.0'
            - --port
            - '8000'
          env:
            - name: HF_HOME
              value: '${MODEL_CACHE_MOUNT_PATH}'
            - name: HUGGINGFACE_HUB_CACHE
              value: '${MODEL_CACHE_MOUNT_PATH}'
          ports:
            - containerPort: 8000
          resources:
            limits:
              nvidia.com/gpu: '${VLLM_GPU_LIMIT}'
              cpu: '${VLLM_CPU_LIMIT}'
              memory: '${VLLM_MEMORY_LIMIT}'
            requests:
              nvidia.com/gpu: '${VLLM_GPU_REQUEST}'
              cpu: '${VLLM_CPU_REQUEST}'
              memory: '${VLLM_MEMORY_REQUEST}'
              ephemeral-storage: '${VLLM_EPHEMERAL_REQUEST}'
          readinessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 60
            periodSeconds: 30
          volumeMounts:
            - name: model-cache
              mountPath: '${MODEL_CACHE_MOUNT_PATH}'
      volumes:
        - name: model-cache
          persistentVolumeClaim:
            claimName: huggingface-model-cache

# To back the cache with Cloud Storage FUSE instead of a PVC, replace the model-cache volume
# with a gcsfuse.csi.storage.gke.io volume and add gke-gcsfuse/volumes annotation.
