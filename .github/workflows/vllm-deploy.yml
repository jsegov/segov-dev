name: vLLM Cloud Run GPU Deployment

on:
  push:
    branches: [main]
    paths:
      - 'infra/gcp-vllm/Dockerfile'
      - 'infra/gcp-vllm/cloudrun-vllm.yaml'
      - 'infra/gcp-vllm/deploy-cloudrun.sh'
  workflow_dispatch:
    inputs:
      model_id:
        description: 'Model ID to deploy (default: Qwen/Qwen3-8B)'
        required: false
        default: 'Qwen/Qwen3-8B'

permissions:
  id-token: write
  contents: read

jobs:
  deploy-vllm:
    runs-on: ubuntu-latest
    environment: prod
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Set deployment variables
        id: vars
        run: |
          PROJECT_ID="${{ vars.GCP_PROJECT_ID }}"
          REGION="${{ vars.VLLM_REGION }}"
          SERVICE_NAME="${{ vars.VLLM_SERVICE_NAME }}"
          ARTIFACT_REPO="${{ vars.ARTIFACT_REPO }}"
          SERVICE_ACCOUNT="${{ vars.SERVICE_ACCOUNT }}"
          MODEL_ID="${{ inputs.model_id }}"
          
          if [ -z "$REGION" ]; then
            REGION="us-east4"
          fi
          if [ -z "$SERVICE_NAME" ]; then
            SERVICE_NAME="vllm-inference"
          fi
          if [ -z "$ARTIFACT_REPO" ]; then
            ARTIFACT_REPO="containers"
          fi
          if [ -z "$SERVICE_ACCOUNT" ]; then
            SERVICE_ACCOUNT="mcp-sa@${PROJECT_ID}.iam.gserviceaccount.com"
          fi
          if [ -z "$MODEL_ID" ]; then
            MODEL_ID="Qwen/Qwen3-8B"
          fi
          
          echo "PROJECT_ID=${PROJECT_ID}" >> $GITHUB_ENV
          echo "REGION=${REGION}" >> $GITHUB_ENV
          echo "SERVICE_NAME=${SERVICE_NAME}" >> $GITHUB_ENV
          echo "ARTIFACT_REPO=${ARTIFACT_REPO}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT=${SERVICE_ACCOUNT}" >> $GITHUB_ENV
          echo "MODEL_ID=${MODEL_ID}" >> $GITHUB_ENV
      
      - name: Ensure HF_TOKEN secret exists
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          if [ -z "$HF_TOKEN" ]; then
            echo "::error title=Missing Secret::HF_TOKEN secret must be set"
            exit 1
          fi
          
          if ! gcloud secrets describe HF_TOKEN --project=${PROJECT_ID} &>/dev/null; then
            echo "Creating HF_TOKEN secret in Secret Manager..."
            echo -n "${HF_TOKEN}" | gcloud secrets create HF_TOKEN \
              --data-file=- \
              --project=${PROJECT_ID}
          fi
          
          gcloud secrets add-iam-policy-binding HF_TOKEN \
            --member="serviceAccount:${SERVICE_ACCOUNT}" \
            --role="roles/secretmanager.secretAccessor" \
            --project=${PROJECT_ID} 2>/dev/null || true
      
      - name: Ensure Artifact Registry repository exists
        run: |
          if ! gcloud artifacts repositories describe ${ARTIFACT_REPO} \
              --location=${REGION} \
              --project=${PROJECT_ID} &>/dev/null; then
            gcloud artifacts repositories create ${ARTIFACT_REPO} \
              --repository-format=docker \
              --location=${REGION} \
              --project=${PROJECT_ID}
          fi
      
      - name: Build container image
        working-directory: infra/gcp-vllm
        run: |
          IMAGE_TAG="${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPO}/${SERVICE_NAME}:$(date +%s)"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          
          cat > .cloudbuild-vllm.yaml << EOF
          steps:
          - name: 'gcr.io/cloud-builders/docker'
            args: ['build', '-t', '${IMAGE_TAG}', '.']
          images:
          - '${IMAGE_TAG}'
          timeout: '1800s'
          EOF
          
          gcloud builds submit \
            --config=.cloudbuild-vllm.yaml \
            --project=${PROJECT_ID} .
          
          rm -f .cloudbuild-vllm.yaml
      
      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base
      
      - name: Deploy to Cloud Run with GPU
        working-directory: infra/gcp-vllm
        run: |
          export CONTAINER_IMAGE="${IMAGE_TAG}"
          export PROJECT_ID="${PROJECT_ID}"
          export REGION="${REGION}"
          export SERVICE_NAME="${SERVICE_NAME}"
          export SERVICE_ACCOUNT="${SERVICE_ACCOUNT}"
          
          envsubst < cloudrun-vllm.yaml > cloudrun-vllm.rendered.yaml
          
          gcloud run services replace cloudrun-vllm.rendered.yaml \
            --region=${REGION} \
            --project=${PROJECT_ID}
          
          rm -f cloudrun-vllm.rendered.yaml
      
      - name: Configure IAM
        run: |
          gcloud run services add-iam-policy-binding ${SERVICE_NAME} \
            --member="serviceAccount:${SERVICE_ACCOUNT}" \
            --role="roles/run.invoker" \
            --region=${REGION} \
            --project=${PROJECT_ID} 2>/dev/null || true
      
      - name: Get service URL
        id: url
        run: |
          SERVICE_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format='value(status.url)')
          
          echo "url=${SERVICE_URL}" >> $GITHUB_OUTPUT
          echo "::notice title=Deployment Complete::vLLM deployed to ${SERVICE_URL}"
          echo "Update OPENAI_BASE_URL to: ${SERVICE_URL}/v1"
