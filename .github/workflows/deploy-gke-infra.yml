name: Deploy GKE Infra

on:
  push:
    branches: [main]
    paths:
      - 'infra/gke/**'
      - '.github/workflows/deploy-gke-infra.yml'
  workflow_dispatch: {}

permissions:
  contents: read
  id-token: write

concurrency:
  group: gke-infra-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: ${{ secrets.GCP_PROJECT }}
      GKE_CLUSTER_NAME: ${{ secrets.GKE_CLUSTER_NAME }}
      GKE_CLUSTER_LOCATION: ${{ secrets.GKE_CLUSTER_LOCATION }}
      GKE_STATIC_IP_NAME: ${{ secrets.GKE_STATIC_IP_NAME }}
      GKE_DOMAIN: ${{ secrets.GKE_DOMAIN }}
      VLLM_GCP_SERVICE_ACCOUNT: ${{ secrets.VLLM_GCP_SERVICE_ACCOUNT }}
      GKE_ARMOR_POLICY: ${{ secrets.GKE_ARMOR_POLICY }}  # Optional: leave empty to skip Cloud Armor
      GKE_STORAGE_CLASS: ${{ vars.GKE_STORAGE_CLASS }}
      MODEL_CACHE_STORAGE: ${{ vars.GKE_MODEL_CACHE_STORAGE }}
      VLLM_IMAGE: ${{ vars.GKE_VLLM_IMAGE }}
      VLLM_GPU_LIMIT: ${{ vars.GKE_VLLM_GPU_LIMIT }}
      VLLM_GPU_REQUEST: ${{ vars.GKE_VLLM_GPU_REQUEST }}
      VLLM_CPU_LIMIT: ${{ vars.GKE_VLLM_CPU_LIMIT }}
      VLLM_CPU_REQUEST: ${{ vars.GKE_VLLM_CPU_REQUEST }}
      VLLM_MEMORY_LIMIT: ${{ vars.GKE_VLLM_MEMORY_LIMIT }}
      VLLM_MEMORY_REQUEST: ${{ vars.GKE_VLLM_MEMORY_REQUEST }}
      VLLM_EPHEMERAL_REQUEST: ${{ vars.GKE_VLLM_EPHEMERAL_REQUEST }}
      VLLM_MODEL_ID: ${{ vars.GKE_VLLM_MODEL_ID }}
      GKE_GPU_TYPE: ${{ vars.GKE_GPU_TYPE }}
      VLLM_REPLICAS: ${{ vars.GKE_VLLM_REPLICAS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_ID_PROVIDER }}
          service_account: ${{ secrets.GCP_DEPLOYER_SA_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}
          install_components: 'gke-gcloud-auth-plugin'

      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.30.0'

      - name: Install envsubst
        run: sudo apt-get update && sudo apt-get install -y gettext-base

      - name: Fetch GKE credentials
        uses: google-github-actions/get-gke-credentials@v1
        with:
          cluster_name: ${{ env.GKE_CLUSTER_NAME }}
          location: ${{ env.GKE_CLUSTER_LOCATION }}

      - name: Deploy manifests
        run: |
          bash infra/gke/scripts/deploy_gke.sh

      - name: Show rollout status
        run: |
          kubectl get pods -n inference
          kubectl get ingress vllm -n inference
