name: Cloud Run Deployment

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      ref:
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
      
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}
      
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
      
      - name: Set deployment variables
        id: vars
        run: |
          PROJECT_ID="${{ vars.GCP_PROJECT_ID }}"
          REGION="${{ vars.REGION }}"
          SERVICE_NAME="${{ vars.SERVICE_NAME }}"
          ARTIFACT_REPO="${{ vars.ARTIFACT_REPO }}"
          CHAT_MODEL_ID="${{ vars.CHAT_MODEL_ID }}"
          OPENAI_BASE_URL="${{ vars.OPENAI_BASE_URL }}"
          GCS_BUCKET_NAME="${{ vars.GCS_BUCKET_NAME }}"
          SERVICE_ACCOUNT="${{ vars.SERVICE_ACCOUNT }}"
          CONNECTOR_NAME="${{ vars.CONNECTOR_NAME }}"
          
          if [ -z "${SERVICE_ACCOUNT}" ]; then
            SERVICE_ACCOUNT="mcp-sa@${PROJECT_ID}.iam.gserviceaccount.com"
          fi
          
          if [ -z "${CONNECTOR_NAME}" ]; then
            CONNECTOR_NAME="cloudrun-connector"
          fi
          
          echo "PROJECT_ID=${PROJECT_ID}" >> $GITHUB_ENV
          echo "REGION=${REGION}" >> $GITHUB_ENV
          echo "SERVICE_NAME=${SERVICE_NAME}" >> $GITHUB_ENV
          echo "ARTIFACT_REPO=${ARTIFACT_REPO}" >> $GITHUB_ENV
          echo "CHAT_MODEL_ID=${CHAT_MODEL_ID}" >> $GITHUB_ENV
          if [ -n "${OPENAI_BASE_URL:-}" ]; then
            echo "OPENAI_BASE_URL=${OPENAI_BASE_URL}" >> $GITHUB_ENV
          fi
          echo "GCS_BUCKET_NAME=${GCS_BUCKET_NAME}" >> $GITHUB_ENV
          echo "SERVICE_ACCOUNT=${SERVICE_ACCOUNT}" >> $GITHUB_ENV
          echo "CONNECTOR_NAME=${CONNECTOR_NAME}" >> $GITHUB_ENV
      
      - name: Build container image
        working-directory: .
        run: |
          IMAGE_TAG="${REGION}-docker.pkg.dev/${PROJECT_ID}/${ARTIFACT_REPO}/${SERVICE_NAME}:$(date +%s)"
          echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
          
          # Create temporary Dockerfile at root
          cp infra/backend/Dockerfile .Dockerfile.backend
          
          # Create Cloud Build config
          sed 's/^          //' > .cloudbuild-backend.yaml << EOF
          steps:
          - name: 'gcr.io/cloud-builders/docker'
            args: ['build', '-f', '.Dockerfile.backend', '-t', '${IMAGE_TAG}', '.']
          images:
          - '${IMAGE_TAG}'
          EOF
          
          # Build using Cloud Build
          gcloud builds submit \
            --config=.cloudbuild-backend.yaml \
            --project=${PROJECT_ID} .
          
          # Cleanup
          rm -f .Dockerfile.backend .cloudbuild-backend.yaml
      
      - name: Install envsubst
        run: |
          sudo apt-get update && sudo apt-get install -y gettext-base
      
      - name: Render Cloud Run service YAML
        working-directory: infra/backend
        run: |
          export CONTAINER_IMAGE="${IMAGE_TAG}"
          export PROJECT_ID="${PROJECT_ID}"
          export REGION="${REGION}"
          export SERVICE_NAME="${SERVICE_NAME}"
          export SERVICE_ACCOUNT="${SERVICE_ACCOUNT}"
          export CHAT_MODEL_ID="${CHAT_MODEL_ID}"
          export GCS_BUCKET_NAME="${GCS_BUCKET_NAME}"
          export CONNECTOR_NAME="${CONNECTOR_NAME}"
          
          if [ -z "${OPENAI_BASE_URL:-}" ]; then
            sed '/^[[:space:]]*- name: OPENAI_BASE_URL/,+1d' cloudrun.yaml | envsubst > ../../backend/cloudrun.rendered.yaml
          else
            export OPENAI_BASE_URL="${OPENAI_BASE_URL}"
            envsubst < cloudrun.yaml > ../../backend/cloudrun.rendered.yaml
          fi
      
      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace backend/cloudrun.rendered.yaml \
            --region=${REGION} \
            --project=${PROJECT_ID}
      
      - name: Ensure authentication is required
        run: |
          gcloud run services remove-iam-policy-binding ${SERVICE_NAME} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --region=${REGION} \
            --project=${PROJECT_ID} 2>/dev/null || echo "allUsers binding not present"
      
      - name: Grant run.invoker to service account
        run: |
          gcloud run services add-iam-policy-binding ${SERVICE_NAME} \
            --member="serviceAccount:${SERVICE_ACCOUNT}" \
            --role="roles/run.invoker" \
            --region=${REGION} \
            --project=${PROJECT_ID} || echo "Invoker binding may already exist"
      
      - name: Get service URL
        id: url
        run: |
          CLOUD_RUN_URL=$(gcloud run services describe ${SERVICE_NAME} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format='value(status.url)')
          echo "url=${CLOUD_RUN_URL}" >> $GITHUB_OUTPUT
          echo "Deployed to: ${CLOUD_RUN_URL}"
      
      - name: Output deployment info
        run: |
          echo "::notice title=Deployment Complete::Service deployed to ${{ steps.url.outputs.url }}"
          echo ""
          echo "Add this to your Vercel environment variables:"
          echo "  CLOUD_RUN_URL=${{ steps.url.outputs.url }}"
